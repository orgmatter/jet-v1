<svelte:head>
  <title>{dictionary[$USER.language].cockpit.title} | P2P Lending Platform</title>
</svelte:head>
<script lang="ts">
  import { onMount } from 'svelte';
  import { Datatable } from 'svelte-simple-datatables';
  import { NATIVE_MINT } from '@solana/spl-token'; 
  import type { Reserve } from '../models/JetTypes';
  import { INIT_FAILED, MARKET, USER } from '../store';
  import { inDevelopment, airdrop } from '../scripts/jet';
  import { currencyFormatter, totalAbbrev, TokenAmount } from '../scripts/util';;
  import { generateCopilotSuggestion } from '../scripts/copilot';
  import { dictionary } from '../scripts/localization'; 
  import Loader from '../components/Loader.svelte';
  import ReserveDetail from '../components/ReserveDetail.svelte';
  import Toggle from '../components/Toggle.svelte';
  import InitFailed from '../components/InitFailed.svelte';
  import ConnectWalletButton from '../components/ConnectWalletButton.svelte';
  import Info from '../components/Info.svelte';
  import TradePanel from '../components/TradePanel.svelte';
  import { btcNgnMarketStorageJob, getBtcLocalStorage } from '../scripts/misc/jobs/btc-ngn-market-storage-job';
  import { usdtNgnMarketStorageJob, getUsdtLocalStorage } from '../scripts/misc/jobs/usdt-ngn-market-storage-job';

// getting local storage data for btc-ngn and usdt-ngn
  let btcNgnMarketStorage: any = getBtcLocalStorage();
  let usdtNgnMarketStorage: any = getUsdtLocalStorage();

  // start btc-ngn, usdt-ngn market storage job
  btcNgnMarketStorageJob(6000).start();
  setInterval(() => {
    btcNgnMarketStorage = getBtcLocalStorage();
  }, 6000)

  $: console.log('btc-ngn-price: ', btcNgnMarketStorage.data[0].adv.price);

  usdtNgnMarketStorageJob(6000).start();
  setInterval(() => {
    usdtNgnMarketStorage = getUsdtLocalStorage();
  }, 6000)

  $: console.log('usdt-ngn-price: ', usdtNgnMarketStorage.data[0].adv.price);

  // Reserve detail controller
  let reserveDetail: Reserve | null = null;

  // Datatable settings
  const tableSettings: any = {
    sortable: false,
    pagination: false,
    scrollY: false,
    blocks: {
      searchInput: true
    },
    labels: {
        search: dictionary[$USER.language].cockpit.search,    
    }
  };

  // new BtcNgnMarketJob();

  // new declaration method from svelte-simple-datatable
  let rows: any;

  // If in development, can request airdrop for testing
  const doAirdrop = async (reserve: Reserve): Promise<void> => {
    let amount = TokenAmount.tokens("100", reserve.decimals);
    if(reserve.tokenMintPubkey.equals(NATIVE_MINT)) {
      amount = TokenAmount.tokens("1", reserve.decimals);
    }

    const [ok, txid] = await airdrop(reserve.abbrev, amount.amount);
    if (ok && txid) {
      $USER.addNotification({
        success: true,
        text: dictionary[$USER.language].copilot.alert.airdropSuccess
          .replaceAll('{{UI AMOUNT}}', amount.uiAmount)
          .replaceAll('{{RESERVE ABBREV}}', reserve.abbrev)
      });
    } else if (!ok && !txid) {
      $USER.addNotification({
        success: false,
        text: dictionary[$USER.language].cockpit.txFailed
      });
    }
  };

  // Init Cockpit
  onMount(() => {
    // If user is subject to liquidation, warn them
    if ($USER.position.borrowedValue && $USER.position.colRatio <= $MARKET.minColRatio) {
      generateCopilotSuggestion();
    }

    // Add search icon to table search input
    const searchIcon = document.createElement('i');
    searchIcon.classList.add('search', 'text-gradient', 'fas', 'fa-search');
    document.querySelector('.dt-search')?.appendChild(searchIcon);
  });
</script>

{#if $INIT_FAILED || $USER.geobanned}
  <InitFailed />
{:else if $MARKET && $USER}
  <div class="view-container flex justify-center column">
    <h1 class="view-title text-gradient">
      {dictionary[$USER.language].cockpit.title}
    </h1>
    <div class="connect-wallet-btn">
      <ConnectWalletButton />
    </div>
    <div class="cockpit-top flex align-center justify-between">
      <div class="trade-market-tvl flex align-start justify-center column">
        <div class="divider">
        </div>
        <h2 class="view-subheader">
          {dictionary[$USER.language].cockpit.totalValueLocked}
        </h2>
        <h1 class="view-header text-gradient">
            {#if $MARKET.marketInit}
              {totalAbbrev($MARKET.totalValueLocked)}
            {:else}
              --
            {/if}
          </h1>
      </div>
      <div class="trade-position-snapshot flex-centered">
        <div class="trade-position-ratio flex align-start justify-center column">
          <div class="flex-centered">
            <h2 class="view-subheader">
              {dictionary[$USER.language].cockpit.yourRatio}
            </h2>
            <Info term="collateralizationRatio" />
          </div>
          {#if $USER.walletInit && $MARKET.marketInit}
            <h1 class="view-header"
            style="margin-bottom: -20px; {$USER.wallet
              ? ($USER.position.borrowedValue && (Math.floor($USER.position.colRatio) <= $MARKET.minColRatio) 
                ? 'color: var(--failure);' 
                  : 'color: var(--success);')
                : ''}">
              {#if $USER.position.borrowedValue && $USER.position.colRatio > 10}
                &gt;1000
              {:else if $USER.position.borrowedValue && $USER.position.colRatio < 10}
                {currencyFormatter($USER.position.colRatio * 100, false, 1)}
              {:else}
                ∞
              {/if}
              {#if $USER.position.borrowedValue}
                <span style="color: inherit; padding-left: 2px;">
                  %
                </span>
              {/if}
            </h1>
          {:else}
            <p>
              --
            </p>
          {/if}
        </div>
        <div class="flex-centered column">
          <div class="trade-position-value flex-centered column">
            <h2 class="view-subheader">
              {dictionary[$USER.language].cockpit.totalDepositedValue}
            </h2>
            {#if $USER.walletInit}
              <p class="bicyclette text-gradient">
                {totalAbbrev($USER.position.depositedValue ?? 0)}
              </p>
            {:else}
              <p class="bicyclette">
                --
              </p>
            {/if}
          </div>
          <div class="trade-position-value flex-centered column">
            <h2 class="view-subheader">
              {dictionary[$USER.language].cockpit.totalBorrowedValue}
            </h2>
            {#if $USER.walletInit}
              <p class="bicyclette text-gradient">
                {totalAbbrev($USER.position.borrowedValue ?? 0)}
              </p>
            {:else}
              <p class="bicyclette">
                --
              </p>
            {/if}
          </div>
        </div>
      </div>
    </div>
    <TradePanel />
    <Datatable settings={tableSettings} data={$MARKET.reservesArray} bind:dataRows={rows}>
      <thead>
        <th data-key="name">
          {dictionary[$USER.language].cockpit.asset} 
        </th>
        <th data-key="abbrev"
          class="native-toggle">
          <Toggle onClick={() => MARKET.update(market => {
            market.nativeValues = !market.nativeValues;
            return market;
          })}
            active={!$MARKET.nativeValues} 
            native 
          />
        </th>
        <th data-key="availableLiquidity">
          {dictionary[$USER.language].cockpit.availableLiquidity}
        </th>
        <th data-key="depositRate">
          {dictionary[$USER.language].cockpit.depositRate}
          <Info term="depositRate" />
        </th>
        <th data-key="borrowRate" class="datatable-border-right">
          {dictionary[$USER.language].cockpit.borrowRate}
          <Info term="borrowRate" />
        </th>
        <th data-key="">
          {dictionary[$USER.language].cockpit.walletBalance}
        </th>
        <th data-key="">
          {dictionary[$USER.language].cockpit.amountDeposited}
        </th>
        <th data-key="">
          {dictionary[$USER.language].cockpit.amountBorrowed}
        </th>
        <th data-key="">
          <!--Empty column for arrow-->
        </th>
      </thead>
      <div class="datatable-divider">
      </div>
      <tbody>
        {#if rows}
          {#each $rows as row, i}
          <tr class="datatable-spacer">
            <td><!-- Extra Row for spacing --></td>
          </tr>
          <tr class:active={$MARKET.currentReserve.abbrev === $rows[i].abbrev}
            on:click={() => MARKET.update(market => {
              market.currentReserve = $rows[i];
              return market;
            })}>
            <td class="dt-asset">
              <img src="img/cryptos/{$rows[i].abbrev}.png"
                alt="{$rows[i].abbrev} Icon"
              />
              <span>
                {$rows[i].name}
              </span>
              <span>
                {#if $rows[i].abbrev === 'NAI'}
                  ≈ NAI{usdtNgnMarketStorage.data[0].adv.price.toLocaleString('en-US', {
                    style: "currency",
                    currency: "NGN"
                  })}
                {:else}
                  ≈ 
                  {#if $MARKET.marketInit}
                    {currencyFormatter($rows[i].price, true, 2)}
                  {:else}
                    --
                  {/if}
                {/if}
              </span>
            </td>
            <td on:click={() => reserveDetail = $rows[i]} 
              class="reserve-detail">
              {$rows[i].abbrev} {dictionary[$USER.language].cockpit.detail}
            </td>
            <td>
              {#if $MARKET.marketInit}
                {totalAbbrev(
                  $rows[i].availableLiquidity.uiAmountFloat,
                  $rows[i].price,
                  $MARKET.nativeValues,
                  2
                )}
              {:else}
                --
              {/if}
            </td>
            <td>
              {#if $MARKET.marketInit}
                {$rows[i].depositRate ? ($rows[i].depositRate * 100).toFixed(2) : 0}%
              {:else}
                --%
              {/if}
            </td>
            <td class="datatable-border-right">
              {#if $MARKET.marketInit}
                {$rows[i].borrowRate ? ($rows[i].borrowRate * 100).toFixed(2) : 0}%
              {:else}
                --%
              {/if}
            </td>
            <td class:dt-bold={$USER.walletBalances[$rows[i].abbrev]} 
              class:dt-balance={$USER.walletBalances[$rows[i].abbrev]}>
              {#if $USER.walletInit}
                {#if $USER.walletBalances[$rows[i].abbrev] > 0
                  && $USER.walletBalances[$rows[i].abbrev] < 0.0005}
                  ~0
                {:else}
                  {#if $MARKET.marketInit}
                    {totalAbbrev(
                      $USER.walletBalances[$rows[i].abbrev] ?? 0,
                      $rows[i].price,
                      $MARKET.nativeValues,
                      3
                    )}
                  {:else}
                    --
                  {/if}
                {/if}
              {:else}
                  --
              {/if}
            </td>
            <td class:dt-bold={$USER.collateralBalances[$rows[i].abbrev]}
              style={$USER.collateralBalances[$rows[i].abbrev] ? 
                'color: var(--jet-green) !important;' : ''}>
              {#if $USER.walletInit}
                {#if $USER.collateralBalances[$rows[i].abbrev] > 0
                  && $USER.collateralBalances[$rows[i].abbrev] < 0.0005}
                  ~0
                {:else}
                  {#if $MARKET.marketInit}
                    {totalAbbrev(
                      $USER.collateralBalances[$rows[i].abbrev] ?? 0,
                      $rows[i].price,
                      $MARKET.nativeValues,
                      3
                    )}
                  {:else}
                    --
                  {/if}
                {/if}
              {:else}
                  --
              {/if}
            </td>
            <td class:dt-bold={$USER.loanBalances[$rows[i].abbrev]}
              style={$USER.loanBalances[$rows[i].abbrev] ? 
              'color: var(--jet-blue) !important;' : ''}>
              {#if $USER.walletInit}
                {#if $USER.loanBalances[$rows[i].abbrev] > 0
                  && $USER.loanBalances[$rows[i].abbrev] < 0.0005}
                  ~0
                {:else}
                  {#if $MARKET.marketInit}
                    {totalAbbrev(
                      $USER.loanBalances[$rows[i].abbrev] ?? 0,
                      $rows[i].price,
                      $MARKET.nativeValues,
                      3
                    )}
                  {:else}
                    --
                  {/if}
                {/if}
              {:else}
                --
              {/if}
            </td>
            <!--Faucet for testing if in development-->
            <!--Replace with inDevelopment for mainnet-->
            {#if inDevelopment}
              <td class="faucet" on:click={() => doAirdrop($rows[i])}>
                <i class="text-gradient fas fa-parachute-box"
                  title="Airdrop {$rows[i].abbrev}"
                  style="margin-right: var(--spacing-lg); font-size: 18px !important;">
                </i>
              </td>
            {:else}
              <td>
                  <i class="text-gradient jet-icons">
                    ➜
                  </i>
                </td>
            {/if}
          </tr>
          <tr class="datatable-spacer">
            <td><!-- Extra Row for spacing --></td>
          </tr>
        {/each}
        {/if}
      </tbody>
    </Datatable>
  </div>
  {#if reserveDetail}
    <ReserveDetail {reserveDetail} {usdtNgnMarketStorage}
      closeModal={() => reserveDetail = null} 
    />
  {/if}
{:else}
  <Loader fullview />
{/if}

<style>
  .view-container {
    position: relative;
  }
  .cockpit-top {
    flex-wrap: wrap;
    padding: var(--spacing-xs) 0 var(--spacing-lg) 0;
  }
  .connect-wallet-btn {
    position: absolute;
    top: var(--spacing-md);
    right: var(--spacing-sm);
  }
  .trade-market-tvl .divider {
    margin: 0 0 var(--spacing-lg) 0;
  }
  .trade-position-snapshot {
    min-width: 275px;
    border-radius: var(--border-radius);
    box-shadow: var(--neu-shadow-inset);
    padding: var(--spacing-sm) var(--spacing-lg);
    background: var(--light-grey);
  }
  .trade-position-snapshot p {
    font-size: 25px;
  }
  .trade-position-ratio {
    padding-right: 50px;
  }
  .trade-position-value {
    padding: var(--spacing-sm) 0;
  }
  
  @media screen and (max-width: 1100px) {
    .cockpit-top {
      flex-direction: column;
      align-items: flex-start;
      padding-top: unset;
    }
    .connect-wallet-btn {
      display: none;
    }
    .trade-market-tvl, .trade-position-snapshot {
      min-width: unset;
      margin: var(--spacing-xs) 0;
      padding: var(--spacing-xs) var(--spacing-md);
    }
    .trade-position-snapshot h1 {
      font-size: 40px;
      line-height: 40px;
    }
    .trade-position-snapshot p {
      font-size: 20px;
      line-height: 20px;
    }
    .trade-position-ratio {
      padding-right: 30px;
    }
  }
</style>